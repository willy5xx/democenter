#!/usr/bin/env node

/**
 * Generate go2rtc.yaml from database configuration
 * 
 * This script reads site configurations from the database and generates
 * a go2rtc.yaml file with the appropriate streams configured.
 * 
 * Usage:
 *   node backend/scripts/generate-go2rtc-config.js [--output path/to/go2rtc.yaml]
 */

import Database from 'better-sqlite3';
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Parse command line arguments
const args = process.argv.slice(2);
const outputIndex = args.indexOf('--output');
const outputPath = outputIndex !== -1 && args[outputIndex + 1]
  ? args[outputIndex + 1]
  : path.join(__dirname, '../../go2rtc.yaml');

console.log('üîß Generating go2rtc.yaml from database...\n');

// Connect to database
const dbPath = path.join(__dirname, '../db/config.db');

if (!fs.existsSync(dbPath)) {
  console.error('‚ùå Database not found at:', dbPath);
  console.error('   Run `npm run db:migrate && npm run db:seed` first');
  process.exit(1);
}

const db = new Database(dbPath);

// Fetch all sites
const sites = db.prepare('SELECT * FROM sites').all();

if (sites.length === 0) {
  console.error('‚ùå No sites found in database');
  console.error('   Run `npm run db:seed` to create initial site');
  process.exit(1);
}

console.log(`Found ${sites.length} site(s) in database:`);
sites.forEach(site => {
  console.log(`  - ${site.name} (${site.camera_url})`);
});
console.log('');

// Generate streams configuration
const streams = {};

sites.forEach((site, index) => {
  const sitePrefix = sites.length > 1 ? `site${site.id}_` : '';
  
  // Parse dewarp parameters
  const dewarpParams = JSON.parse(site.dewarp_params || '{}');
  const { cx = 0.5, cy = 0.5, k1 = -0.23, k2 = -0.02 } = dewarpParams;
  
  // Main stream (raw from camera)
  const mainStreamName = `${sitePrefix}main`;
  streams[mainStreamName] = [site.camera_url];
  
  // Dewarped stream for virtual PTZ
  const dewarpedStreamName = `${sitePrefix}dewarped`;
  
  // Build FFmpeg filter chain
  const filters = [];
  
  // Lens correction (dewarp) - only if enabled
  const enableDewarp = dewarpParams.enable_dewarp !== false; // Default to true for backward compatibility
  
  if (enableDewarp) {
    filters.push(`lenscorrection=cx=${cx}:cy=${cy}:k1=${k1}:k2=${k2}`);
  }
  
  // Optional crop (if specified in dewarp_params)
  if (dewarpParams.crop_x !== undefined) {
    const { crop_x, crop_y, crop_width, crop_height } = dewarpParams;
    filters.push(`crop=${crop_width}:${crop_height}:${crop_x}:${crop_y}`);
  }
  
  // Scale to standard resolution
  const [width, height] = (site.stream_resolution || '1920x1080').split('x');
  filters.push(`scale=${width}:${height}`);
  
  const filterChain = filters.join(',');
  
  // FFmpeg stream with optimized settings for low latency
  streams[dewarpedStreamName] = [
    `ffmpeg:${mainStreamName}#video=h264#raw=-fflags nobuffer+genpts -flags low_delay -probesize 32 -analyzeduration 0 -vf ${filterChain} -c:v libx264 -preset ultrafast -tune zerolatency -crf 23 -g 5 -bf 0 -x264-params keyint=5:min-keyint=5:scenecut=0:bframes=0:ref=1`
  ];
});

// Build complete configuration
const config = {
  streams,
  webrtc: {
    listen: ':8555',
    ice_servers: [
      {
        urls: ['stun:stun.l.google.com:19302']
      }
    ]
  },
  api: {
    listen: ':1984'
  },
  log: {
    level: 'info'
  }
};

// Add header comment
const header = `# go2rtc Configuration - Auto-generated from database
#
# This file was automatically generated by: backend/scripts/generate-go2rtc-config.js
# Generated: ${new Date().toISOString()}
# Sites configured: ${sites.length}
#
# ‚ö†Ô∏è  WARNING: Manual changes to this file may be overwritten!
# To modify camera configuration, update the database via the API or calibration tool.
#
# After updating this file, restart go2rtc:
#   docker-compose restart go2rtc
#

`;

// Generate YAML
const yamlContent = yaml.dump(config, { indent: 2, lineWidth: -1 });
const fullContent = header + yamlContent;

// Backup existing file if it exists
if (fs.existsSync(outputPath)) {
  const backupPath = outputPath + '.backup';
  fs.copyFileSync(outputPath, backupPath);
  console.log(`üì¶ Backed up existing config to: ${backupPath}`);
}

// Write new configuration
fs.writeFileSync(outputPath, fullContent);
console.log(`‚úÖ Generated go2rtc.yaml at: ${outputPath}\n`);

// Show stream summary
console.log('üì° Configured streams:');
Object.keys(streams).forEach(streamName => {
  console.log(`   - ${streamName}`);
});
console.log('');

// Show next steps
console.log('üìù Next steps:');
console.log('   1. Review the generated go2rtc.yaml file');
console.log('   2. Restart go2rtc: docker-compose restart go2rtc');
console.log('   3. Test streams at: http://localhost:1984/');
console.log('');

db.close();

