<!DOCTYPE html>
<html>
<head>
    <title>Stream Performance Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .stream-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .stream-box {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        .stream-box h2 {
            margin-top: 0;
            color: #4ade80;
        }
        video {
            width: 100%;
            background: black;
            border-radius: 4px;
        }
        .stats {
            margin-top: 10px;
            font-size: 14px;
            color: #94a3b8;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 10px;
        }
        .status.connected {
            background: #22c55e;
            color: white;
        }
        .status.connecting {
            background: #eab308;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¥ Stream Performance Test</h1>
    <p>Compare the direct camera feed vs processed streams to diagnose lag issues.</p>
    
    <div class="stream-container">
        <div class="stream-box">
            <h2>Direct Stream (No Processing)</h2>
            <p>Raw camera feed - should be smooth with minimal lag</p>
            <video id="direct-video" autoplay muted playsinline></video>
            <div class="stats">
                <div>Status: <span class="status connecting" id="direct-status">Connecting...</span></div>
                <div id="direct-stats"></div>
            </div>
        </div>
        
        <div class="stream-box">
            <h2>Processed Stream (Dewarped)</h2>
            <p>With lens correction, crop, and scale processing</p>
            <video id="processed-video" autoplay muted playsinline></video>
            <div class="stats">
                <div>Status: <span class="status connecting" id="processed-status">Connecting...</span></div>
                <div id="processed-stats"></div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background: #2a2a2a; border-radius: 8px;">
        <h3>ðŸ“Š Diagnosis Guide:</h3>
        <ul>
            <li><strong>Both streams lag:</strong> Network or camera issue</li>
            <li><strong>Only processed stream lags:</strong> FFmpeg processing bottleneck (confirmed!)</li>
            <li><strong>Both streams smooth:</strong> Issue may be in dashboard WebRTC handling</li>
        </ul>
    </div>

    <script>
        async function initStream(streamName, videoElement, statusElement, statsElement) {
            try {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                });

                pc.addTransceiver("video", { direction: "recvonly" });
                pc.addTransceiver("audio", { direction: "recvonly" });

                pc.ontrack = (event) => {
                    videoElement.srcObject = event.streams[0];
                    statusElement.textContent = "Connected";
                    statusElement.className = "status connected";
                    
                    // Monitor stats
                    setInterval(async () => {
                        const stats = await pc.getStats();
                        stats.forEach(report => {
                            if (report.type === 'inbound-rtp' && report.kind === 'video') {
                                const fps = report.framesPerSecond || 0;
                                const bytes = report.bytesReceived || 0;
                                const mbps = ((bytes * 8) / 1000000).toFixed(2);
                                statsElement.innerHTML = `FPS: ${fps} | Data: ${mbps} Mbps`;
                            }
                        });
                    }, 1000);
                };

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                // Wait for ICE gathering
                await new Promise((resolve) => {
                    if (pc.iceGatheringState === "complete") {
                        resolve();
                    } else {
                        const timeout = setTimeout(() => resolve(), 2000);
                        pc.onicegatheringstatechange = () => {
                            if (pc.iceGatheringState === "complete") {
                                clearTimeout(timeout);
                                resolve();
                            }
                        };
                    }
                });

                const response = await fetch(`http://localhost:1984/api/webrtc?src=${streamName}`, {
                    method: "POST",
                    body: pc.localDescription.sdp,
                    headers: { "Content-Type": "application/x-sdp" }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const answer = await response.text();
                await pc.setRemoteDescription({ type: "answer", sdp: answer });
                
                console.log(`âœ… ${streamName} connected`);
            } catch (error) {
                console.error(`âŒ ${streamName} failed:`, error);
                statusElement.textContent = "Failed: " + error.message;
                statusElement.className = "status connecting";
            }
        }

        // Initialize both streams
        window.addEventListener('load', () => {
            initStream('tapo_direct', 
                      document.getElementById('direct-video'),
                      document.getElementById('direct-status'),
                      document.getElementById('direct-stats'));
            
            initStream('tapo_dewarped',
                      document.getElementById('processed-video'),
                      document.getElementById('processed-status'),
                      document.getElementById('processed-stats'));
        });
    </script>
</body>
</html>



